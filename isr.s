	;; Trap Service Routine
%macro TSR_NOERRCODE 1
	[global tsr%1]
tsr%1:
	push dword 0
	push dword %1
	jmp tsr_common_stub
%endmacro

%macro TSR_ERRCODE 1
	[global tsr%1]
tsr%1:
	push dword %1
	jmp tsr_common_stub
%endmacro

	KERNEL_DATA_SEGMENT equ 0x10
	
	;; Import tsr_handler.
	[extern tsr_handler]
tsr_common_stub:
	;; Push the processor state.
	pusha
	mov ax, ds
	;; Push the old data segment.
	push eax
	;; Load the kernel data segment.
	mov ax, KERNEL_DATA_SEGMENT
	mov ds, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
	call tsr_handler
	;; Pop the old data segment.
	pop eax
	;; Load the old data segment.
	mov ds, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
	;; Pop the processor state.
	popa
	;; Pop the interrupt number and error code.
	add esp, 8
	iret
	
TSR_NOERRCODE 0
TSR_NOERRCODE 1
TSR_NOERRCODE 2
TSR_NOERRCODE 3
TSR_NOERRCODE 4
TSR_NOERRCODE 5
TSR_NOERRCODE 6
TSR_NOERRCODE 7
TSR_ERRCODE 8
TSR_NOERRCODE 9
TSR_ERRCODE 10
TSR_ERRCODE 11
TSR_ERRCODE 12
TSR_ERRCODE 13
TSR_ERRCODE 14
TSR_NOERRCODE 15
TSR_NOERRCODE 16
TSR_NOERRCODE 17
TSR_NOERRCODE 18
TSR_NOERRCODE 19
TSR_NOERRCODE 20
TSR_NOERRCODE 21
TSR_NOERRCODE 22
TSR_NOERRCODE 23
TSR_NOERRCODE 24
TSR_NOERRCODE 25
TSR_NOERRCODE 26
TSR_NOERRCODE 27
TSR_NOERRCODE 28
TSR_NOERRCODE 29
TSR_NOERRCODE 30
TSR_NOERRCODE 31
TSR_NOERRCODE 32
TSR_NOERRCODE 33
TSR_NOERRCODE 34
TSR_NOERRCODE 35
TSR_NOERRCODE 36
TSR_NOERRCODE 37
TSR_NOERRCODE 38
TSR_NOERRCODE 39
TSR_NOERRCODE 40
TSR_NOERRCODE 41
TSR_NOERRCODE 42
TSR_NOERRCODE 43
TSR_NOERRCODE 44
TSR_NOERRCODE 45
TSR_NOERRCODE 46
TSR_NOERRCODE 47
TSR_NOERRCODE 48
TSR_NOERRCODE 49
TSR_NOERRCODE 50
TSR_NOERRCODE 51
TSR_NOERRCODE 52
TSR_NOERRCODE 53
TSR_NOERRCODE 54
TSR_NOERRCODE 55
TSR_NOERRCODE 56
TSR_NOERRCODE 57
TSR_NOERRCODE 58
TSR_NOERRCODE 59
TSR_NOERRCODE 60
TSR_NOERRCODE 61
TSR_NOERRCODE 62
TSR_NOERRCODE 63
TSR_NOERRCODE 64
TSR_NOERRCODE 65
TSR_NOERRCODE 66
TSR_NOERRCODE 67
TSR_NOERRCODE 68
TSR_NOERRCODE 69
TSR_NOERRCODE 70
TSR_NOERRCODE 71
TSR_NOERRCODE 72
TSR_NOERRCODE 73
TSR_NOERRCODE 74
TSR_NOERRCODE 75
TSR_NOERRCODE 76
TSR_NOERRCODE 77
TSR_NOERRCODE 78
TSR_NOERRCODE 79
TSR_NOERRCODE 80
TSR_NOERRCODE 81
TSR_NOERRCODE 82
TSR_NOERRCODE 83
TSR_NOERRCODE 84
TSR_NOERRCODE 85
TSR_NOERRCODE 86
TSR_NOERRCODE 87
TSR_NOERRCODE 88
TSR_NOERRCODE 89
TSR_NOERRCODE 90
TSR_NOERRCODE 91
TSR_NOERRCODE 92
TSR_NOERRCODE 93
TSR_NOERRCODE 94
TSR_NOERRCODE 95
TSR_NOERRCODE 96
TSR_NOERRCODE 97
TSR_NOERRCODE 98
TSR_NOERRCODE 99
TSR_NOERRCODE 100
TSR_NOERRCODE 101
TSR_NOERRCODE 102
TSR_NOERRCODE 103
TSR_NOERRCODE 104
TSR_NOERRCODE 105
TSR_NOERRCODE 106
TSR_NOERRCODE 107
TSR_NOERRCODE 108
TSR_NOERRCODE 109
TSR_NOERRCODE 110
TSR_NOERRCODE 111
TSR_NOERRCODE 112
TSR_NOERRCODE 113
TSR_NOERRCODE 114
TSR_NOERRCODE 115
TSR_NOERRCODE 116
TSR_NOERRCODE 117
TSR_NOERRCODE 118
TSR_NOERRCODE 119
TSR_NOERRCODE 120
TSR_NOERRCODE 121
TSR_NOERRCODE 122
TSR_NOERRCODE 123
TSR_NOERRCODE 124
TSR_NOERRCODE 125
TSR_NOERRCODE 126
TSR_NOERRCODE 127
TSR_NOERRCODE 128
TSR_NOERRCODE 129
TSR_NOERRCODE 130
TSR_NOERRCODE 131
TSR_NOERRCODE 132
TSR_NOERRCODE 133
TSR_NOERRCODE 134
TSR_NOERRCODE 135
TSR_NOERRCODE 136
TSR_NOERRCODE 137
TSR_NOERRCODE 138
TSR_NOERRCODE 139
TSR_NOERRCODE 140
TSR_NOERRCODE 141
TSR_NOERRCODE 142
TSR_NOERRCODE 143
TSR_NOERRCODE 144
TSR_NOERRCODE 145
TSR_NOERRCODE 146
TSR_NOERRCODE 147
TSR_NOERRCODE 148
TSR_NOERRCODE 149
TSR_NOERRCODE 150
TSR_NOERRCODE 151
TSR_NOERRCODE 152
TSR_NOERRCODE 153
TSR_NOERRCODE 154
TSR_NOERRCODE 155
TSR_NOERRCODE 156
TSR_NOERRCODE 157
TSR_NOERRCODE 158
TSR_NOERRCODE 159
TSR_NOERRCODE 160
TSR_NOERRCODE 161
TSR_NOERRCODE 162
TSR_NOERRCODE 163
TSR_NOERRCODE 164
TSR_NOERRCODE 165
TSR_NOERRCODE 166
TSR_NOERRCODE 167
TSR_NOERRCODE 168
TSR_NOERRCODE 169
TSR_NOERRCODE 170
TSR_NOERRCODE 171
TSR_NOERRCODE 172
TSR_NOERRCODE 173
TSR_NOERRCODE 174
TSR_NOERRCODE 175
TSR_NOERRCODE 176
TSR_NOERRCODE 177
TSR_NOERRCODE 178
TSR_NOERRCODE 179
TSR_NOERRCODE 180
TSR_NOERRCODE 181
TSR_NOERRCODE 182
TSR_NOERRCODE 183
TSR_NOERRCODE 184
TSR_NOERRCODE 185
TSR_NOERRCODE 186
TSR_NOERRCODE 187
TSR_NOERRCODE 188
TSR_NOERRCODE 189
TSR_NOERRCODE 190
TSR_NOERRCODE 191
TSR_NOERRCODE 192
TSR_NOERRCODE 193
TSR_NOERRCODE 194
TSR_NOERRCODE 195
TSR_NOERRCODE 196
TSR_NOERRCODE 197
TSR_NOERRCODE 198
TSR_NOERRCODE 199
TSR_NOERRCODE 200
TSR_NOERRCODE 201
TSR_NOERRCODE 202
TSR_NOERRCODE 203
TSR_NOERRCODE 204
TSR_NOERRCODE 205
TSR_NOERRCODE 206
TSR_NOERRCODE 207
TSR_NOERRCODE 208
TSR_NOERRCODE 209
TSR_NOERRCODE 210
TSR_NOERRCODE 211
TSR_NOERRCODE 212
TSR_NOERRCODE 213
TSR_NOERRCODE 214
TSR_NOERRCODE 215
TSR_NOERRCODE 216
TSR_NOERRCODE 217
TSR_NOERRCODE 218
TSR_NOERRCODE 219
TSR_NOERRCODE 220
TSR_NOERRCODE 221
TSR_NOERRCODE 222
TSR_NOERRCODE 223
TSR_NOERRCODE 224
TSR_NOERRCODE 225
TSR_NOERRCODE 226
TSR_NOERRCODE 227
TSR_NOERRCODE 228
TSR_NOERRCODE 229
TSR_NOERRCODE 230
TSR_NOERRCODE 231
TSR_NOERRCODE 232
TSR_NOERRCODE 233
TSR_NOERRCODE 234
TSR_NOERRCODE 235
TSR_NOERRCODE 236
TSR_NOERRCODE 237
TSR_NOERRCODE 238
TSR_NOERRCODE 239
TSR_NOERRCODE 240
TSR_NOERRCODE 241
TSR_NOERRCODE 242
TSR_NOERRCODE 243
TSR_NOERRCODE 244
TSR_NOERRCODE 245
TSR_NOERRCODE 246
TSR_NOERRCODE 247
TSR_NOERRCODE 248
TSR_NOERRCODE 249
TSR_NOERRCODE 250
TSR_NOERRCODE 251
TSR_NOERRCODE 252
TSR_NOERRCODE 253
TSR_NOERRCODE 254
TSR_NOERRCODE 255
